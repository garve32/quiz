<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ict.quiz.web.questions.QuestionMapper">

    <select id="findById" resultType="Question">
        select id, text, image, seq, use_yn, category_id
          from question
         where id = #{id}
    </select>

    <select id="findByQuestionId" resultType="QuestionOption">
        select id, number, seq, text, correct_yn, question_id
          from question_option
         where question_id = #{question_id}
    </select>

    <select id="getCategory" resultType="Category">
        select id, name, p_id, question_cnt, success_cnt
          from category
         where id = #{category_id}
    </select>

    <select id="pickRandomQuestion" resultType="UserQuestion">
        select #{user_id} as user_id
             , (select ifnull(max(seq), 0) + 1
                from user_question
                where user_id = 3) as seq
             , category_id
             , group_concat(id order by id) as question_set
             , group_concat(0) as progress_set
             , group_concat(0) as correct_set
        from (select category_id, id
                from question
               where category_id = #{category_id}
               order by rand()
               limit #{question_cnt}) as t1
        group by category_id
    </select>

    <insert id="saveUserQuestion">
        insert into user_question (
            user_id, seq, category_id, question_set, progress_set, correct_set, start_dt, end_dt
        )
        values (
            #{user_id}
            , #{seq}
            , #{category_id}
            , #{question_set}
            , #{progress_set}
            , #{correct_set}
            , #{start_dt}
            , #{end_dt}
        )
        <selectKey keyColumn="id" keyProperty="id" order="AFTER" resultType="UserQuestion">
            select id
              from user_question
             where user_id = #{user_id}
               and seq = #{seq}
        </selectKey>
    </insert>

</mapper>