<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ict.quiz.web.admin.AdminMapper">

    <sql id="search">
        <!-- 카테고리 선택 시 필터 적용 -->
        <if test="category_id != null and category_id != ''">
            AND t1.category_id = #{category_id}
        </if>
        <!-- 제목 검색어가 있을 때 제목 LIKE 검색 -->
        <if test="searchKeyword != null and searchKeyword != ''">
            AND t1.text LIKE '%' || #{searchKeyword} || '%'
        </if>
    </sql>

    <select id="findAllQuestions" parameterType="QuestionPage" resultType="QuestionPage">
        select t1.id, t1.text, t1.image_name, t1.image, t1.seq, t1.use_yn, t1.category_id
             , t2.name as category_nm
          from question t1
               inner join category t2
                       on t2.id = t1.category_id
        where 1=1
          <include refid="search" />
         order by id
        LIMIT #{recordsPerPage} OFFSET #{pagination.firstRecordIndex}
    </select>

    <select id="findAllQuestionsCount" parameterType="QuestionPage" resultType="int">
        select count(*)
          from question t1
                inner join category t2
                on t2.id = t1.category_id
         where 1=1
        <include refid="search" />
    </select>

    <insert id="insertQuestion" parameterType="Question" useGeneratedKeys="true" keyProperty="id">
        insert into question (
            text, image_name, image, seq, use_yn, type, category_id
        )
        values (
            #{text}
            ,#{image_name}
            ,#{image}
            ,#{seq}
            ,#{use_yn}
            ,#{type}
            ,#{category_id}
            )
    </insert>

    <update id="updateQuestion" parameterType="Question">
        update question
        set text = #{text}
            , image_name = #{image_name}
            , image = #{image}
            , seq = #{seq}
            , use_yn = #{use_yn}
            , type = #{type}
            , category_id =#{category_id}
        where id = #{id}
    </update>

    <update id="updateQuestionNotFile" parameterType="Question">
        update question
        set text = #{text}
          , seq = #{seq}
          , use_yn = #{use_yn}
          , type = #{type}
          , category_id =#{category_id}
        where id = #{id}
    </update>

    <insert id="insertOption" parameterType="QuestionOption" useGeneratedKeys="true" keyProperty="id">
        insert into question_option (
            number, seq, text, correct_yn, del_yn, question_id
        ) values (
            #{number}
            ,#{seq}
            ,#{text}
            ,#{correct_yn}
            ,#{del_yn}
            ,#{question_id}
            )
    </insert>

    <update id="updateOption" parameterType="QuestionOption">
        update question_option
        set number = #{number}
            , seq = #{seq}
            , text = #{text}
            , correct_yn = #{correct_yn}
            , del_yn = #{del_yn}
            , question_id = #{question_id}
        where id = #{id}
    </update>

    <select id="findAllCategories" resultType="Category">
        select id, p_id, name, description, time_limit, question_cnt, logo_url
             , success_type, success_cnt, success_percent, use_yn, active_yn, seq
        from category
        order by seq, id
    </select>

    <select id="findCategories" resultType="Category">
        select id, p_id, name, description, time_limit, question_cnt, logo_url
             , success_type, success_cnt, success_percent, use_yn, active_yn, seq
        from category
        where use_yn = 'Y'
          and question_cnt > 0
        order by seq, id
    </select>

    <select id="findCategoryById" resultType="Category">
        select id, p_id, name, description, time_limit, question_cnt, logo_url
             , success_type, success_cnt, success_percent, use_yn, active_yn, seq
        from category
        where id = #{id}
    </select>
    <select id="findQuestionSelectStatsByCategory" resultType="QuestionStat">
        SELECT
            q.id   AS question_id,
            q.text AS question_text,
            COALESCE(COUNT(*) FILTER (WHERE q.id = q_ids.elem::bigint), 0) AS select_count,
            COALESCE(COUNT(*) FILTER (WHERE q.id = q_ids.elem::bigint AND corr.elem = '1'), 0) AS correct_count,
            CASE
                WHEN COALESCE(COUNT(*) FILTER (WHERE q.id = q_ids.elem::bigint), 0) > 0 THEN
                    ROUND(
                        (COALESCE(COUNT(*) FILTER (WHERE q.id = q_ids.elem::bigint AND corr.elem = '1'), 0)::numeric
                            * 100.0)
                        / COALESCE(COUNT(*) FILTER (WHERE q.id = q_ids.elem::bigint), 0), 2
                    )
                ELSE 0
            END AS correct_rate
        FROM question q
        LEFT JOIN user_question uq
               ON uq.category_id = q.category_id
        LEFT JOIN LATERAL unnest(string_to_array(uq.question_set, ',')) WITH ORDINALITY AS q_ids(elem, idx)
               ON TRUE
        LEFT JOIN LATERAL unnest(string_to_array(uq.correct_set, ',')) WITH ORDINALITY AS corr(elem, idx2)
               ON corr.idx2 = q_ids.idx
        WHERE q.category_id = #{categoryId}
        GROUP BY q.id, q.text
        ORDER BY select_count DESC, q.id
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <update id="updateCategory" parameterType="Category">
        update category
        set name = #{name}
          , description = #{description}
          , logo_url = #{logo_url}
          , time_limit = #{time_limit}
          , question_cnt = #{question_cnt}
          , success_type = #{success_type}
          , success_cnt = #{success_cnt}
          , success_percent = #{success_percent}
          , use_yn = #{use_yn}
          , active_yn = #{active_yn}
          , seq = #{seq}
        where id = #{id}
    </update>

    <insert id="insertCategory" parameterType="Category" useGeneratedKeys="true" keyProperty="id">
        insert into category (
            p_id, name, description, time_limit, question_cnt, logo_url,
            success_type, success_cnt, success_percent, use_yn, active_yn, seq
        ) values (
            #{p_id}, #{name}, #{description}, #{time_limit}, #{question_cnt}, #{logo_url},
            #{success_type}, #{success_cnt}, #{success_percent}, #{use_yn}, #{active_yn}, #{seq}
        )
    </insert>

    <select id="findRecentExamAttempts" resultType="ExamAttemptSummary">
        SELECT
            u.id                 AS user_id,
            u.login_id           AS user_login_id,
            u.name               AS user_name,
            uq.seq               AS seq,
            c.id                 AS category_id,
            c.name               AS category_name,
            CASE
                WHEN uq.correct_set IS NULL OR uq.correct_set = '' THEN 0
                ELSE ROUND(
                    (
                        (SELECT COUNT(*) FROM unnest(string_to_array(uq.correct_set, ',')) AS t(x) WHERE x = '1')::numeric
                        * 100.0
                    ) / NULLIF(array_length(string_to_array(uq.correct_set, ','), 1), 0), 2
                )
            END                  AS score_percent,
            uq.success_cd        AS success_cd,
            uq.start_dt          AS start_dt,
            uq.end_dt            AS end_dt
        FROM user_question uq
        JOIN "user" u ON u.id = uq.user_id
        JOIN category c ON c.id = uq.category_id
        ORDER BY uq.start_dt DESC NULLS LAST
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countExamAttempts" resultType="int">
        SELECT COUNT(*) FROM user_question
    </select>

    <select id="findQuestionSelectStatsCountByCategory" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM question q
        WHERE q.category_id = #{categoryId}
    </select>

    <select id="findCategorySummary" parameterType="long" resultType="CategorySummary">
        WITH uq AS (
            SELECT * FROM user_question WHERE category_id = #{categoryId}
        ),
        qcnt AS (
            SELECT COUNT(*) AS question_cnt FROM question WHERE category_id = #{categoryId}
        )
        SELECT
            (SELECT COUNT(*) FROM uq) AS attempts,
            (SELECT COUNT(*) FROM uq WHERE end_dt IS NOT NULL) AS completed,
            CASE WHEN (SELECT COUNT(*) FROM uq) > 0
                THEN ROUND(((SELECT COUNT(*) FROM uq WHERE end_dt IS NOT NULL)::numeric
                    * 100.0) / (SELECT COUNT(*) FROM uq), 2)
                ELSE 0 END AS completion_rate,
            (SELECT COUNT(*) FROM uq WHERE success_cd = 'S') AS success,
            CASE WHEN (SELECT COUNT(*) FROM uq) > 0
                THEN ROUND(((SELECT COUNT(*) FROM uq WHERE success_cd = 'S')::numeric
                    * 100.0) / (SELECT COUNT(*) FROM uq), 2)
                ELSE 0 END AS success_rate,
            (SELECT ROUND(AVG(accum_sec), 2) FROM uq) AS avg_seconds,
            (SELECT ROUND(AVG(accum_sec / NULLIF(qcnt.question_cnt, 0)), 2) FROM uq, qcnt) AS avg_seconds_per_question
    </select>

    <!-- 해설 관련 쿼리들 -->
    <sql id="explanationSearch">
        <!-- 카테고리 선택 시 필터 적용 -->
        <if test="category_id != null and category_id != ''">
            AND t2.category_id = #{category_id}
        </if>
        <!-- 제목 검색어가 있을 때 해설 내용 또는 문제 내용 LIKE 검색 -->
        <if test="searchKeyword != null and searchKeyword != ''">
            AND (t1.explanation_text LIKE '%' || #{searchKeyword} || '%' 
                 OR t2.text LIKE '%' || #{searchKeyword} || '%')
        </if>
    </sql>

    <select id="findAllExplanations" parameterType="QuestionExplanationPage" resultType="QuestionExplanationPage">
        SELECT 
            t1.id, 
            t1.question_id, 
            t1.explanation_text, 
            t1.image_name, 
            t1.image, 
            t1.use_yn,
            t2.text as question_text,
            t3.name as category_name,
            t2.category_id
        FROM question_explanation t1
        INNER JOIN question t2 ON t2.id = t1.question_id
        INNER JOIN category t3 ON t3.id = t2.category_id
        WHERE 1=1
        <include refid="explanationSearch" />
        ORDER BY t1.id DESC
        LIMIT #{recordsPerPage} OFFSET #{pagination.firstRecordIndex}
    </select>

    <select id="findAllExplanationsCount" parameterType="QuestionExplanationPage" resultType="int">
        SELECT COUNT(*)
        FROM question_explanation t1
        INNER JOIN question t2 ON t2.id = t1.question_id
        INNER JOIN category t3 ON t3.id = t2.category_id
        WHERE 1=1
        <include refid="explanationSearch" />
    </select>

    <select id="findExplanationById" parameterType="long" resultType="QuestionExplanationPage">
        SELECT 
            t1.id, 
            t1.question_id, 
            t1.explanation_text, 
            t1.image_name, 
            t1.image, 
            t1.use_yn,
            t2.text as question_text,
            t3.name as category_name,
            t2.category_id
        FROM question_explanation t1
        INNER JOIN question t2 ON t2.id = t1.question_id
        INNER JOIN category t3 ON t3.id = t2.category_id
        WHERE t1.id = #{id}
    </select>

    <select id="findExplanationByQuestionId" parameterType="long" resultType="QuestionExplanationPage">
        SELECT 
            t1.id, 
            t1.question_id, 
            t1.explanation_text, 
            t1.image_name, 
            t1.image, 
            t1.use_yn,
            t2.text as question_text,
            t3.name as category_name,
            t2.category_id
        FROM question_explanation t1
        INNER JOIN question t2 ON t2.id = t1.question_id
        INNER JOIN category t3 ON t3.id = t2.category_id
        WHERE t1.question_id = #{questionId} AND t1.use_yn = 'Y'
        LIMIT 1
    </select>

    <insert id="insertExplanation" parameterType="QuestionExplanationPage" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO question_explanation (
            question_id, explanation_text, image_name, image, use_yn
        ) VALUES (
            #{question_id}, #{explanation_text}, #{image_name}, #{image}, #{use_yn}
        )
    </insert>

    <update id="updateExplanation" parameterType="QuestionExplanationPage">
        UPDATE question_explanation
        SET question_id = #{question_id},
            explanation_text = #{explanation_text},
            image_name = #{image_name},
            image = #{image},
            use_yn = #{use_yn}
        WHERE id = #{id}
    </update>

    <update id="updateExplanationNotFile" parameterType="QuestionExplanationPage">
        UPDATE question_explanation
        SET question_id = #{question_id},
            explanation_text = #{explanation_text},
            use_yn = #{use_yn}
        WHERE id = #{id}
    </update>

    <select id="findQuestionsForExplanation" resultType="QuestionPage">
        SELECT 
            t1.id, 
            t1.text, 
            t1.category_id,
            t2.name as category_nm
        FROM question t1
        INNER JOIN category t2 ON t2.id = t1.category_id
        WHERE t1.use_yn = 'Y'
        ORDER BY t2.seq, t1.id
    </select>

    <!-- 해설 등록 여부와 함께 문제 목록 조회 -->
    <select id="findQuestionsWithExplanationStatus" parameterType="QuestionPage" resultType="QuestionPage">
        SELECT 
            t1.id, 
            t1.text, 
            t1.image, 
            t1.seq, 
            t1.use_yn, 
            t1.type, 
            t1.category_id,
            t2.name as category_nm,
            CASE WHEN t3.id IS NOT NULL THEN true ELSE false END as has_explanation
        FROM question t1
        INNER JOIN category t2 ON t2.id = t1.category_id
        LEFT JOIN question_explanation t3 ON t3.question_id = t1.id AND t3.use_yn = 'Y'
        WHERE 1=1
        <include refid="search" />
        ORDER BY t1.id
        LIMIT #{recordsPerPage} OFFSET #{pagination.firstRecordIndex}
    </select>

    <select id="findQuestionsWithExplanationStatusCount" parameterType="QuestionPage" resultType="int">
        SELECT COUNT(*)
        FROM question t1
        INNER JOIN category t2 ON t2.id = t1.category_id
        WHERE 1=1
        <include refid="search" />
    </select>

</mapper>